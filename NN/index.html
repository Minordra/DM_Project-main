<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบพยากรณ์ความเข้ากันได้ของคู่รัก</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/brain.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      min-height: 100vh;
    }
    .card {
      border: none;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-header {
      background-color: #007bff;
      color: #fff;
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
    }
    .btn-custom {
      background-color: #28a745;
      color: #fff;
    }
    .btn-custom:hover {
      background-color: #218838;
      color: #fff;
    }
    .form-label {
      font-weight: 500;
    }
    #result, #logs {
      font-size: 1.1rem;
      font-weight: 500;
    }
    #logs {
      max-height: 200px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #dee2e6;
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="#">คู่รัก AI</a>
    </div>
  </nav>
  
  <div class="container my-5">
    <div class="card mx-auto" style="max-width: 800px;">
      <div class="card-header text-center">
        <h2>ระบบพยากรณ์ความเข้ากันได้ของคู่รัก</h2>
        <p class="mb-0">อัปโหลดไฟล์ CSV หรือกรอกข้อมูลเพื่อคำนวณความเข้ากันได้</p>
      </div>
      <div class="card-body">
        <form id="predictionForm">
          <div class="mb-4">
            <label for="csvFile" class="form-label">อัปโหลดไฟล์ CSV</label>
            <input type="file" class="form-control" id="csvFile" accept=".csv" onchange="handleFileUpload(event)">
          </div>
          <div class="text-center mb-4">
            <button type="button" class="btn btn-custom" onclick="trainModel()">ฝึกโมเดล</button>
          </div>
          <hr>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="userGender" class="form-label">เพศของผู้ใช้</label>
              <select class="form-select" id="userGender">
                <option value="0">หญิง</option>
                <option value="1">ชาย</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="userAge" class="form-label">อายุของผู้ใช้</label>
              <input type="number" class="form-control" id="userAge" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="userRace" class="form-label">เชื้อชาติของผู้ใช้</label>
              <select class="form-select" id="userRace">
                <option value="1">Black/African American</option>
                <option value="2">European/Caucasian-American</option>
                <option value="3">Latino/Hispanic American</option>
                <option value="4">Asian/Pacific Islander/Asian-American</option>
                <option value="5">Native American</option>
                <option value="6">Other</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="partnerAge" class="form-label">อายุของคู่เดต</label>
              <input type="number" class="form-control" id="partnerAge" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="partnerRace" class="form-label">เชื้อชาติของคู่เดต</label>
              <select class="form-select" id="partnerRace">
                <option value="1">Black/African American</option>
                <option value="2">European/Caucasian-American</option>
                <option value="3">Latino/Hispanic American</option>
                <option value="4">Asian/Pacific Islander/Asian-American</option>
                <option value="5">Native American</option>
                <option value="6">Other</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="partnerAttr" class="form-label">คะแนนเสน่ห์ของคู่เดต</label>
              <input type="number" class="form-control" id="partnerAttr" min="0" max="10" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="partnerSinc" class="form-label">คะแนนความจริงใจของคู่เดต</label>
              <input type="number" class="form-control" id="partnerSinc" min="0" max="10" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="partnerIntel" class="form-label">คะแนนสติปัญญาของคู่เดต</label>
              <input type="number" class="form-control" id="partnerIntel" min="0" max="10" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="partnerFun" class="form-label">คะแนนความสนุกของคู่เดต</label>
              <input type="number" class="form-control" id="partnerFun" min="0" max="10" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="partnerAmb" class="form-label">คะแนนความทะเยอทะยานของคู่เดต</label>
              <input type="number" class="form-control" id="partnerAmb" min="0" max="10" required>
            </div>
          </div>
          <div class="mb-4">
            <label for="partnerShared" class="form-label">คะแนนการแบ่งปันของคู่เดต</label>
            <input type="number" class="form-control" id="partnerShared" min="0" max="10" required>
          </div>
          <div class="text-center">
            <button type="button" class="btn btn-primary" onclick="predictMatch()">คำนวณความเข้ากันได้</button>
          </div>
        </form>
        <div class="mt-4" id="result"></div>
        <hr>
        <h5 class="mt-4">Log Output</h5>
        <div id="logs"></div>
      </div>
    </div>
  </div>

  <!-- Script สำหรับการจัดการโมเดลและ CSV -->
  <script>
    const net = new brain.NeuralNetwork();
    let trainingData = [];

    // ฟังก์ชันสำหรับเพิ่มข้อความใน log
    function addLog(message) {
      const logsDiv = document.getElementById("logs");
      const p = document.createElement("p");
      p.textContent = message;
      logsDiv.appendChild(p);
    }

    // ฟังก์ชันสำหรับอ่านไฟล์ CSV
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        addLog("อ่านไฟล์ CSV สำเร็จ");
        processCSV(text);
      };
      reader.readAsText(file);
    }
    
    // ฟังก์ชันสำหรับแปลงข้อมูล CSV เป็น trainingData
    function processCSV(csv) {
      const lines = csv.split("\n");
      trainingData = [];
      
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        // ตรวจสอบว่ามีข้อมูลครบ 13 คอลัมน์ (index 0 - 12)
        if (cols.length < 13) continue;
        
        // input: col[1] - col[11] => 11 ค่า
        const input = cols.slice(1, 12).map(Number);
        // output: col[12] => 1 ค่า
        const output = [Number(cols[12])];
        
        trainingData.push({ input, output });
      }
      addLog(`ประมวลผล CSV แล้ว ได้ trainingData จำนวน ${trainingData.length} รายการ`);
      alert("ไฟล์ CSV โหลดสำเร็จ! กดปุ่ม 'ฝึกโมเดล' เพื่อเริ่มเทรน");
    }

    // ฟังก์ชันสำหรับฝึกโมเดล
    function trainModel() {
      if (trainingData.length === 0) {
        alert("กรุณาอัปโหลดไฟล์ CSV ก่อนเทรนโมเดล");
        addLog("ไม่พบ trainingData กรุณาอัปโหลดไฟล์ CSV ก่อน");
        return;
      }
      addLog("เริ่มฝึกโมเดล...");
      net.train(trainingData, { 
        log: true, 
        iterations: 6000, 
        learningRate: 0.10 
      });
      addLog("โมเดลได้รับการฝึกสำเร็จ!");
      alert("โมเดลได้รับการฝึกสำเร็จ!");
    }

    // ฟังก์ชันสำหรับทำนายค่าความเข้ากันได้จากฟอร์ม
    function predictMatch() {
      // รวบรวมข้อมูลจากฟอร์ม
      const userGender = parseFloat(document.getElementById("userGender").value);
      const userAge = parseFloat(document.getElementById("userAge").value);
      const userRace = parseFloat(document.getElementById("userRace").value);
      const partnerAge = parseFloat(document.getElementById("partnerAge").value);
      const partnerRace = parseFloat(document.getElementById("partnerRace").value);
      const partnerAttr = parseFloat(document.getElementById("partnerAttr").value);
      const partnerSinc = parseFloat(document.getElementById("partnerSinc").value);
      const partnerIntel = parseFloat(document.getElementById("partnerIntel").value);
      const partnerFun = parseFloat(document.getElementById("partnerFun").value);
      const partnerAmb = parseFloat(document.getElementById("partnerAmb").value);
      const partnerShared = parseFloat(document.getElementById("partnerShared").value);
      
      // รูปแบบข้อมูล input ต้องตรงกับ training (11 ค่า)
      const inputData = [
        userGender,
        userAge,
        userRace,
        partnerAge,
        partnerRace,
        partnerAttr,
        partnerSinc,
        partnerIntel,
        partnerFun,
        partnerAmb,
        partnerShared
      ];

      addLog("เริ่มการทำนายค่าความเข้ากันได้...");
      const output = net.run(inputData);
      let prediction = output[0];
      const percent = (prediction * 100).toFixed(2);
      
      let message;
      if (prediction >= 0.5) {
        message = `โอกาสความเข้ากันได้สูง (${percent}%)`;
      } else {
        message = `โอกาสความเข้ากันได้ต่ำ (${percent}%)`;
      }

      // แสดงผลลัพธ์
      document.getElementById("result").innerHTML = `
        <div class="alert alert-info text-center">
          ผลการทำนาย: ${message}
        </div>
      `;
      addLog(`การทำนายเสร็จสิ้น: ${message}`);
    }
  </script>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
